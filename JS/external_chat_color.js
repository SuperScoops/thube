/*!
**|  Chatline Enhancements
**|    Color selection system
**|    Messagebuffer text sizing
**|    Persistent chatline history
**|    InstaSync chatline command emulation
**|
**@copyright 2013-2016 Xaekai
**@version 2016.05.21.1211
**@license MIT
**@preserve
*/
var decodeHtmlEntities=function(str){return str.replace(/&#?(\w+);/g,function(match,dec){if(isNaN(dec)){chars={amp:38,quot:34,lt:60,gt:62,laquo:171,raquo:187,larr:8592,rarr:8594,ldquo:8220,rdquo:8221,lsaquo:8249,rsaquo:8250,lsquo:8216,rsquo:8217,acute:180,bdquo:8222,brkbar:166,brvbar:166,cedil:184,cent:162,clubs:9827,copy:169,curren:164,darr:8595,deg:176,diams:9830,die:168,divide:247,euro:8364,frac12:189,frac14:188,frac34:190,frasl:47,hearts:9829,hellip:133,hibar:175,iexcl:161,iquest:191,macr:175,mdash:151,micro:181,middot:183,nbsp:160,ndash:150,not:172,oline:8254,ordf:170,ordm:186,para:182,permil:8240,plusmn:177,pound:163,reg:174,sbquo:8218,sect:167,shy:173,spades:9824,sup1:185,sup2:178,sup3:179,szlig:223,times:215,trade:8482,uarr:8593,uml:168,yen:165,yuml:255,Aacute:193,aacute:225,Acirc:194,acirc:226,AElig:198,aelig:230,Agrave:192,agrave:224,Aring:197,aring:229,Atilde:195,atilde:227,Auml:196,auml:228,Ccedil:199,ccedil:231,Eacute:201,eacute:233,Ecirc:202,ecirc:234,Egrave:200,egrave:232,ETH:208,eth:240,Euml:203,euml:235,Iacute:205,iacute:237,Icirc:206,icirc:238,Igrave:204,igrave:236,Iuml:207,iuml:239,Ntilde:209,ntilde:241,Oacute:211,oacute:243,Ocirc:212,ocirc:244,Ograve:210,ograve:242,Oslash:216,oslash:248,Otilde:213,otilde:245,Ouml:214,ouml:246,THORN:222,thorn:254,Uacute:218,uacute:250,Ucirc:219,ucirc:251,Ugrave:217,ugrave:249,Uuml:220,uuml:252,Yacute:221,yacute:253,Alpha:913,alpha:945,Beta:914,beta:946,Gamma:915,gamma:947,Delta:916,delta:948,Epsilon:917,epsilon:949,Zeta:918,zeta:950,Eta:919,eta:951,Theta:920,theta:952,Iota:921,iota:953,Kappa:922,kappa:954,Lambda:923,lambda:955,Mu:924,mu:956,Nu:925,nu:957,Xi:926,xi:958,Omicron:927,omicron:959,Pi:928,pi:960,Rho:929,rho:961,Sigma:931,sigma:963,Tau:932,tau:964,Upsilon:933,upsilon:965,Phi:934,phi:966,Chi:935,chi:967,Psi:936,psi:968,Omega:937,omega:969,dagger:8224,Dagger:8225};if(chars[dec]!==undefined){dec=chars[dec]}}return String.fromCharCode(dec)})};window.tts=function(data){if(!window.ttsToggle&&!$("#forcetts").length){return}var base="https://tts.cyzon.us/tts?text=";var msg=data.msg.replace(/<img class="channel-emote" src=".*?" title=":(.{1,40}):"[^>]*>/g,"$1").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/<.*?>/g,"");var decodeHtmlEntities=function(str){return str.replace(/&#?(\w+);/g,function(match,dec){if(isNaN(dec)){chars={quot:34,amp:38,lt:60,gt:62,nbsp:160,copy:169,reg:174,deg:176,frasl:47,trade:8482,euro:8364,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,spades:9824,clubs:9827,hearts:9829,diams:9830,oline:8254,larr:8592,uarr:8593,rarr:8594,darr:8595,hellip:133,ndash:150,mdash:151,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,brkbar:166,sect:167,uml:168,die:168,ordf:170,laquo:171,not:172,shy:173,macr:175,hibar:175,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Alpha:913,alpha:945,Beta:914,beta:946,Gamma:915,gamma:947,Delta:916,delta:948,Epsilon:917,epsilon:949,Zeta:918,zeta:950,Eta:919,eta:951,Theta:920,theta:952,Iota:921,iota:953,Kappa:922,kappa:954,Lambda:923,lambda:955,Mu:924,mu:956,Nu:925,nu:957,Xi:926,xi:958,Omicron:927,omicron:959,Pi:928,pi:960,Rho:929,rho:961,Sigma:931,sigma:963,Tau:932,tau:964,Upsilon:933,upsilon:965,Phi:934,phi:966,Chi:935,chi:967,Psi:936,psi:968,Omega:937,omega:969};if(chars[dec]!==undefined){dec=chars[dec]}}return String.fromCharCode(dec)})};new Audio(base+encodeURIComponent(decodeHtmlEntities(msg))).play()};if(!window.ttsLoaded){window.ttsLoaded=true;window.ttsToggle=false;socket.on("chatMsg",function(data){return window.tts(data)})}if(!window[CHANNEL.name])window[CHANNEL.name]={};if(!window[CHANNEL.name].chatline)window[CHANNEL.name].chatline={};window[CHANNEL.name].chatline.cycleDo=function(){var color=this.setting.cycle[this.setting.cycleState];this.setting.cycleState++;this.setting.cycleState=this.setting.cycleState<this.setting.cycle.length&&this.setting.cycleState||0;return color};window[CHANNEL.name].chatline.handleStaticColorSet=function(color){var current=this.setting;current.type="static";current.static=color;window[CHANNEL.name].VirtualWhisper("Chatline: Static color changed to "+color);return window[CHANNEL.name].chatline.propagate(current)};window[CHANNEL.name].chatline.handleCycleColorReset=function(color){var current=this.setting;current.type="cycle";current.cycle.length=0;current.cycle.push(color);window[CHANNEL.name].VirtualWhisper("Chatline: Cycle wiped and populated with "+color);return window[CHANNEL.name].chatline.propagate(current)};window[CHANNEL.name].chatline.handleCycleColorAppend=function(color){var current=this.setting;current.type="cycle";current.cycle.push(color);window[CHANNEL.name].VirtualWhisper("Chatline: Cycle push "+color);return window[CHANNEL.name].chatline.propagate(current)};window[CHANNEL.name].chatline.handleTypeSet=function(type){var current=this.setting;current.type=type;$("div.chat-msg-\\\\\\$server\\\\\\$:contains(Color type)").remove();window[CHANNEL.name].VirtualWhisper("Chatline: Color type changed to "+type);return window[CHANNEL.name].chatline.propagate(current)};window[CHANNEL.name].chatline.handleCycleColorSet=function(cycle){var current=this.setting;current.type="cycle";current.cycle=cycle;window[CHANNEL.name].chatline.propagate(current)};window[CHANNEL.name].chatline.propagate=function(settings){this.setting=settings;localStorage[CHANNEL.name+"_chatlineSetting"]=JSON.stringify(settings)};window[CHANNEL.name].chatline.handleSettingsMessage=function(event,target,message){$(target).val("");var parameters=message.replace(/\/setcolor ?/,"");var current=this.setting;console.log("Chatline: Current settings:"+JSON.stringify(current));if(parameters.match(/toggle/)){window[CHANNEL.name].chatline.toggle()}if(parameters.match(/type|mode/)){parameters=parameters.replace(/type |mode /,"").trim();if(parameters.match(/(static|cycle|random)$/)){return window[CHANNEL.name].chatline.handleTypeSet(parameters)}}if(parameters.match(/static/)){parameters=parameters.replace(/static ?/,"").trim();if(parameters==""){this.handleSettingsMessage(event,target,"/setcolor type static")}if(parameters.match(/#?([a-f0-9]{3}|[a-f0-9]{6})/i)){current.static=parameters;window[CHANNEL.name].VirtualWhisper("Chatline: Static color changed to "+parameters);return window[CHANNEL.name].chatline.propagate(current)}}if(parameters.match(/cycle/)){parameters=parameters.replace(/cycle ?/,"").trim().toLowerCase();if(parameters==""){this.handleSettingsMessage(event,target,"/setcolor type cycle")}var cycle=JSON.parse(parameters);if(cycle.constructor===Array&&cycle.length>0){current.cycle=cycle;current.cycleState=0;window[CHANNEL.name].VirtualWhisper("Chatline: Cycle changed to "+parameters);return window[CHANNEL.name].chatline.propagate(current)}}};window[CHANNEL.name].chatline.toggle=function(){if(window[CHANNEL.name].chatline.toggleState){window[CHANNEL.name].chatline.toggleState=false;window[CHANNEL.name].chatline.toggleButton.addClass("label-default").removeClass("label-info");if(window[CHANNEL.name].chatline.toggleButtonPanel){window[CHANNEL.name].chatline.toggleButtonPanel.addClass("btn-danger").removeClass("btn-success")}localStorage[CHANNEL.name+"_chatlineToggle"]=0}else{window[CHANNEL.name].chatline.toggleState=true;window[CHANNEL.name].chatline.toggleButton.removeClass("label-default").addClass("label-info");if(window[CHANNEL.name].chatline.toggleButtonPanel){window[CHANNEL.name].chatline.toggleButtonPanel.removeClass("btn-danger").addClass("btn-success")}localStorage[CHANNEL.name+"_chatlineToggle"]=1}};window[CHANNEL.name].chatline.fontSize=function(event){var current=this.setting;if(isNaN(current.size))current.size=1;if(event.change=="up"){current.size=Math.min(current.size*10+1,25)/10}else if(event.change=="down"){current.size=Math.max(current.size*10-1,4)/10}else{return}window[CHANNEL.name].chatline.updateStyleSheet(current.size);window[CHANNEL.name].chatline.propagate(current,true);$("div.chat-msg-\\\\\\$server\\\\\\$:contains(Font size)").remove();return window[CHANNEL.name].VirtualWhisper("Chatline: Font size modifier changed to "+current.size+"em.")};window[CHANNEL.name].chatline.css="#messagebuffer div {    font-size: __MODem}";window[CHANNEL.name].chatline.updateStyleSheet=function(size){var sheet=this.css.replace(/__MOD/,size);this.styleSheet.text(sheet)};if(!window[CHANNEL.name].chatline.initialized){window[CHANNEL.name].chatline.initialized=true;window[CHANNEL.name].chatline.toggleState=false;window[CHANNEL.name].chatline.cycleState=0;if(!window[CHANNEL.name].chatline.setting)window[CHANNEL.name].chatline.setting={type:"static",static:"lightgrey",cycle:["orange","yellow","lime"],size:1};if(typeof Storage!=="undefined"){$(window).on("unload.chathistory",function(){localStorage[CHANNEL.name+"_CHATHIST"]=JSON.stringify(CHATHIST.slice(CHATHIST.length>100?CHATHIST.length-100:0,CHATHIST.length))});if(localStorage[CHANNEL.name+"_CHATHIST"]!==undefined){window.CHATHIST=JSON.parse(localStorage[CHANNEL.name+"_CHATHIST"]);window.CHATHISTIDX=CHATHIST.length}if(localStorage[CHANNEL.name+"_chatlineToggle"]===undefined){localStorage[CHANNEL.name+"_chatlineToggle"]=0}else{window[CHANNEL.name].chatline.toggleState=parseInt(localStorage[CHANNEL.name+"_chatlineToggle"])}if(localStorage[CHANNEL.name+"_chatlineSetting"]===undefined){localStorage[CHANNEL.name+"_chatlineSetting"]=JSON.stringify(window[CHANNEL.name].chatline.setting)}else{window[CHANNEL.name].chatline.setting=JSON.parse(localStorage[CHANNEL.name+"_chatlineSetting"]);if(!window[CHANNEL.name].chatline.setting){window[CHANNEL.name].chatline.setting={type:"random",static:"grey",cycle:["orange","yellow","lime"]}}}}else{console.log("ERROR: Local storage not supported by this browser.")}window[CHANNEL.name].chatline.toggleButton=$("<span/>").html('C<span class="toggle-label">hat </span>C<span class="toggle-label">olor</span>').prop("id","ChatcolorToggle").attr("title","Toggle Chat Coloring").addClass("pointer label label-info pull-right").appendTo($("#chatheader")).click(window[CHANNEL.name].chatline.toggle);if(!window[CHANNEL.name].chatline.toggleState){window[CHANNEL.name].chatline.toggleButton.removeClass("label-info").addClass("label-default")}window[CHANNEL.name].chatline.styleSheet=$("<style>").prop("id","chatlineStyle").attr("type","text/css").appendTo("head");if(isNaN(window[CHANNEL.name].chatline.setting.size))window[CHANNEL.name].chatline.setting.size=1;window[CHANNEL.name].chatline.updateStyleSheet(window[CHANNEL.name].chatline.setting.size);$("#chatline").on("staticColorSet",function(event){window[CHANNEL.name].chatline.handleStaticColorSet(event.color)});$("#chatline").on("cycleColorSet",function(event){window[CHANNEL.name].chatline.handleCycleColorReset(event.color)});$("#chatline").on("cycleColorAppend",function(event){window[CHANNEL.name].chatline.handleCycleColorAppend(event.color)});$("#chatline").on("colorTypeSet",function(event){window[CHANNEL.name].chatline.handleTypeSet(event.setting)});$("#chatline").on("fontSize",function(event){window[CHANNEL.name].chatline.fontSize(event)})}$("#chatline").unbind("keyup.enterHold");$("#chatline").on("keyup.enterHold",function(ev){if(ev.keyCode===13){CLIENT.enterHold=false}});$("#chatline").unbind("keydown");$("#chatline").keydown(function(ev){function generateChatlineColor(){function genHex(){return Math.floor(Math.random()*180+75).toString(16)}switch(window[CHANNEL.name].chatline.setting.type){case"random":return"#"+genHex()+genHex()+genHex();break;case"static":return window[CHANNEL.name].chatline.setting.static;break;case"cycle":return window[CHANNEL.name].chatline.cycleDo();break}}if(ev.keyCode==13){if(CHATTHROTTLE){return}var msg=$("#chatline").val();var splitmsg=msg.trim().split(/\s+/);console.info("[DEBUG] "+splitmsg);if(splitmsg[0].match(/\/selfclear|\/sclear/)){Callbacks.clearchat();$("#chatline").val("");return}if(splitmsg[0]=="/spoiler"){$("#messagebuffer").data("spoilertype",$("#messagebuffer").data("spoilertype")==="hover"?"click":"hover");$(".image-spoiler").each(function(){$(this).attr("src",$(this).data()["spoiler"]).attr("data-spoiled","false")});window[CHANNEL.name].VirtualWhisper(String().concat("[System] ","Your spoiler setting is now: ",$("#messagebuffer").data("spoilertype"),"."));$("#chatline").val("");return}if(splitmsg[0]=="/wipesettings"){Object.keys(localStorage).filter((i=>{return i.match(new RegExp("^"+CHANNEL.name))})).each((i=>localStorage.removeItem(i)));window[CHANNEL.name].VirtualWhisper(String().concat("[System] ","Your channel settings have been wiped."));$("#chatline").val("");return}if(splitmsg[0]=="/smartpurge"){if(CLIENT.rank>=CHANNEL.perms.playlistdelete){playlist().filter((i=>{return!(userlist(true).indexOf(i.addedby)>-1)})).each((i=>{socket.emit("delete",i.uid)}));socket.emit("chatMsg",{msg:String().concat("/me ","smartpurged the playlist."),meta:{}})}else{window[CHANNEL.name].VirtualWhisper(String().concat("[System] ","You have insufficient rank to use this."))}$("#chatline").val("");return}if(splitmsg[0]=="/pm"){splitmsg.shift();var user=splitmsg.shift();msg=splitmsg.join(" ").trim();if(userlist(true).indexOf(user)==-1){window[CHANNEL.name].VirtualWhisper(String().concat("[System] User not found."));return}if(!$("#pm-"+user).length){initPm(user).find(".panel-heading").click()}else{if(!msg.length){window[CHANNEL.name].VirtualWhisper(String().concat("[System] ","The PM window is already open retard."))}}if(msg.length){socket.emit("pm",{to:user,msg:msg,meta:{}})}$("#chatline").val("");return}if(CLIENT.rank>=CHANNEL.perms.playlistmove&&splitmsg.length==3&&splitmsg[0]=="/move"){if(!isNaN(parseInt(splitmsg[1]))&&parseInt(splitmsg[1])>0&&parseInt(splitmsg[1])<=$("#queue li").length){if(!isNaN(parseInt(splitmsg[2]))&&parseInt(splitmsg[2])>0&&parseInt(splitmsg[2])<=$("#queue li").length){if(parseInt(splitmsg[2])>parseInt(splitmsg[1])){socket.emit("chatMsg",{msg:"/me moves a video.",meta:{}});socket.emit("moveMedia",{from:$("#queue li").eq(parseInt(splitmsg[1])-1).data("uid"),after:$("#queue li").eq(parseInt(splitmsg[2])-1).data("uid")})}else{socket.emit("chatMsg",{msg:"/me moves a video.",meta:{}});socket.emit("moveMedia",{from:$("#queue li").eq(parseInt(splitmsg[1])-1).data("uid"),after:$("#queue li").eq(parseInt(splitmsg[2])-2).data("uid")})}}}$("#chatline").val("");return}if(CLIENT.rank>=CHANNEL.perms.playlistmove&&splitmsg.length>=2&&splitmsg[0]=="/bump"){splitmsg.shift();var user=splitmsg.shift();var pos=splitmsg.length?parseInt(splitmsg.shift()):-1;var dest;console.log(user,pos);var bumped=$("#queue li").filter(function(v,i){return $(i).data()["blame"].toLowerCase()==user.toLowerCase()}).last();if(!bumped.length){window[CHANNEL.name].VirtualWhisper(String().concat("[MoveMedia] ","Video by user ",user," not found."));$("#chatline").val("");return}if(!(!isNaN(pos)&&pos>0&&pos<=$("#queue li").length)){if(pos!==-1){window[CHANNEL.name].VirtualWhisper(String().concat("[MoveMedia] ","Destination doesn't exist."));$("#chatline").val("");return}else{dest=PL_CURRENT}}else{dest=$("#queue li").eq(pos-1).data("uid")}socket.emit("chatMsg",{msg:"/me moves a video.",meta:{}});socket.emit("moveMedia",{from:bumped.data("uid"),after:dest});$("#chatline").val("");return}if(msg.trim()){var meta={};if(USEROPTS.adminhat&&CLIENT.rank>=255){msg="/a "+msg}else if(USEROPTS.modhat&&CLIENT.rank>=Rank.Moderator){meta.modflair=CLIENT.rank}if(CLIENT.rank>=2&&msg.indexOf("/m ")===0){meta.modflair=CLIENT.rank;msg=msg.substring(3)}maxLength=220;if(msg.indexOf("ssc:")==-1&&(msg[0]!=="/"&&msg[0]!==">")&&msg.length<maxLength&&window[CHANNEL.name].chatline.toggleState){msg="ssc:"+generateChatlineColor()+"  "+msg}if(msg.match(/^\/setcolor/)){return window[CHANNEL.name].chatline.handleSettingsMessage(ev,this,msg)}if(msg.match(/^\/tts/)){window.ttsToggle=!window.ttsToggle;$("#chatline").val("");return}socket.emit("chatMsg",{msg:msg,meta:meta});CHATHIST.push($("#chatline").val());CHATHISTIDX=CHATHIST.length;$("#chatline").val("")}else{if(ev.ctrlKey&&CHATHIST.length){if(CLIENT.enterHold){return}CLIENT.enterHold=true;var msg=CHATHIST[CHATHIST.length-1];var meta={};if(USEROPTS.modhat&&CLIENT.rank>=Rank.Moderator){meta.modflair=CLIENT.rank}if(window[CHANNEL.name].chatline.toggleState){msg="ssc:"+generateChatlineColor()+"  "+msg}socket.emit("chatMsg",{msg:msg,meta:meta})}}return}else if(ev.keyCode==9){chatTabComplete();ev.preventDefault();return false}else if(ev.keyCode==38){if(CHATHISTIDX==CHATHIST.length){CHATHIST.push($("#chatline").val())}if(CHATHISTIDX>0){CHATHISTIDX--;$("#chatline").val(CHATHIST[CHATHISTIDX])}ev.preventDefault();return false}else if(ev.keyCode==40){if(CHATHISTIDX<CHATHIST.length-1){CHATHISTIDX++;$("#chatline").val(CHATHIST[CHATHISTIDX])}ev.preventDefault();return false}});