Callbacks.newPoll=function(data){Callbacks.closePoll();var pollMsg=$("<div/>").addClass("poll-notify").html(data.initiator+' opened a poll: "'+execEmotes(data.title)+'"').appendTo($("#messagebuffer"));scrollChat();var poll=$("<div/>").data("title",data.title).data("options",JSON.stringify(data.options)).addClass("well active").prependTo($("#pollwrap"));$("<button/>").addClass("close pull-right").html("&times;").appendTo(poll).click(function(ev){if(hasPermission("pollctl")&&ev.ctrlKey){var parent=$(this).parent();var title=$("<span>").html(parent.data()["title"]).text();var polloptions=JSON.parse(parent.data()["options"]);polloptions.forEach(((item,index,array)=>{array[index]=$("<span>").html(item).text()}));$("#pollwrap .poll-menu > .btn-danger").click();$("#newpollbtn").click();var menu=$("#pollwrap .poll-menu");var addbtn=menu.find("button:contains(Add Option)");menu.find("strong:contains(Title)").next("input").val(title);menu.find(".poll-menu-option").remove();for(var i=0;i<polloptions.length;i++){$("<input/>").addClass("form-control").attr("type","text").addClass("poll-menu-option").val(polloptions[i]).insertBefore(addbtn)}}poll.remove()});$("<button/>").addClass("btn btn-warning btn-sm pull-right dismiss").html("Dismiss Poll").appendTo(poll).click(function(){poll.addClass("dismissed");$(this).remove()});if(hasPermission("pollctl")){$("<button/>").addClass("btn btn-danger btn-sm pull-right").text("End Poll").appendTo(poll).click(function(ev){if(ev.ctrlKey){var parent=$(this).parent();var title=$("<span>").html(parent.data()["title"]).text();var polloptions=JSON.parse(parent.data()["options"]);polloptions.forEach(((item,index,array)=>{array[index]=$("<span>").html(item).text()}));$("#pollwrap .poll-menu > .btn-danger").click();$("#newpollbtn").click();var menu=$("#pollwrap .poll-menu");var addbtn=menu.find("button:contains(Add Option)");menu.find("strong:contains(Title)").next("input").val(title);menu.find(".poll-menu-option").remove();for(var i=0;i<polloptions.length;i++){$("<input/>").addClass("form-control").attr("type","text").addClass("poll-menu-option").val(polloptions[i]).insertBefore(addbtn)}if(ev.shiftKey||ev.altKey){return}}socket.emit("closePoll")})}$("<h3/>").html(execEmotes(data.title)).appendTo(poll);for(var i=0;i<data.options.length;i++){(function(i){var callback=function(){socket.emit("vote",{option:i});poll.find(".option button").each(function(){$(this).attr("disabled","disabled")});$(this).parent().addClass("option-selected")};$("<button/>").addClass("btn btn-default btn-sm").text(data.counts[i]).prependTo($("<div/>").addClass("option").html(execEmotes(data.options[i])).appendTo(poll)).click(callback)})(i)}if(data.timestamp)$("<span/>").addClass("label label-default pull-right").data("timestamp",data.timestamp).appendTo(poll).text(new Date(data.timestamp).toTimeString().split(" ")[0]);poll.find(".btn").attr("disabled",!hasPermission("pollvote"))};if($("#pollwrap .active").length&&$(".poll-notify").length){var poll=$("#pollwrap .active");var title=poll.find("h3").text().replace(/(https?:\/\/\w+\.\w+[^\s]+)/g,'<a href="$1" target="_blank">$1</a>');var timestamp=poll.find("span.label").data("timestamp");var options=[],votes=[];poll.find("div.option > button").each(function(){votes.push($(this).text());$(this).remove()});poll.find("div.option").each(function(){options.push($(this).text());$(this).remove()});poll.remove();options.forEach(((item,index,array)=>{if(item.match(/https?:\/\/\w+\.\w+/)){array[index]=item.replace(/(https?:\/\/\w+\.\w+[^\s]+)/g,'<a href="$1" target="_blank">$1</a>')}}));var blame=$(".poll-notify").first().text().split(" ").shift();$(".poll-notify").remove();Callbacks.newPoll({title:title,options:options,initiator:blame,counts:votes,timestamp:timestamp})}