/*!
**|  Controllable Avatar Client Script
**|    CyTube Edition
**|      Originally by Cyzon
**|        Rewritten and maintained by Xaekai
**|
**@preserve
*/
"use strict";(function(CyTube_Avatar_Client){return CyTube_Avatar_Client(window,document,window.jQuery)})(function(window,document,$,undefined){if(typeof Storage==="undefined"){console.error("[AvatarClient]","localStorage not supported. Aborting load.");return}else{console.info("[AvatarClient]","Loading Module.")}class AvatarClient{constructor(){Object.assign(this,{initialized:false,showSprites:true,showMessages:true,showNametags:true,roster:{},sprites:[],avatar:false,server:"https://pink.horse:8888",keys:{},WALK_SPEED:10});if(localStorage.getItem(`${CHANNEL.name}_avatarDialogueToggle`)!==null){this.showMessages=parseInt(localStorage.getItem(`${CHANNEL.name}_avatarDialogueToggle`))}if(localStorage.getItem(`${CHANNEL.name}_avatarSpritesToggle`)!==null){this.showSprites=parseInt(localStorage.getItem(`${CHANNEL.name}_avatarSpritesToggle`))}if(localStorage.getItem(`${CHANNEL.name}_avatarNametagToggle`)!==null){this.showNametags=parseInt(localStorage.getItem(`${CHANNEL.name}_avatarNametagToggle`))}return this}initialize(){if(this.initialized){return this}else{this.initialized=true}this.createStyle();this.updateStyle();this.createNavbarControl();this.createCorral();return this}createCorral(){this.corral=$("<div>").attr("id","avatarCorral").prependTo("body")}createNavbarControl(){var navlist=$("#nav-collapsible").children("ul");var control=$("<li>").prop("id","avatarControl");var anchor=$("<a>").prop("id","avatarStartup").attr("href","javascript:void(0)").text("Enable Avatars").click(this.connect.bind(this));navlist.append(control.append(anchor))}createStyle(){this.styleSheet=$("<style>").prop("id","avatarSpritesStyle").attr("type","text/css").appendTo("head")}updateStyle(){var sheet="\n";sheet+=" .avatarSprite-sprite, .avatarSprite-message { position: absolute; } \n";sheet+=` .avatarSprite-sprite { display: ${this.showSprites?"initial":"none"}; } \n`;sheet+=` .avatarSprite-message { display: ${this.showMessages?"initial":"none"}; } \n`;sheet+=` .avatarSprite-nametag { display: ${this.showNametags?"inherit":"none"}; } \n`;this.styleSheet.text(sheet)}createSpriteToggle(target){this.toggleSprites=$("<a>").attr("href","javascript:void(0)").prop("id","avatarSpritesToggle").click(this.spriteToggle.bind(this)).appendTo(target).addClass(this.showSprites?"btn btn-success":"btn btn-danger").text(this.showSprites?"Show Avatars":"Hide Avatars")}spriteToggle(ev){this.showSprites=!this.showSprites;localStorage.setItem(`${CHANNEL.name}_avatarSpritesToggle`,+this.showSprites);this.toggleSprites.text(this.showSprites?"Show Avatars":"Hide Avatars").toggleClass("label-default label-info");this.updateStyle();ev.preventDefault();return false}createDialogeToggle(target){this.toggleDialogue=$("<a>").attr("href","javascript:void(0)").prop("id","avatarDialogueToggle").click(this.dialogueToggle.bind(this)).appendTo(target).addClass(this.showMessages?"btn btn-success":"btn btn-danger").text(this.showMessages?"Sprite dialogue on":"Sprite dialogue off")}dialogueToggle(ev){this.showMessages=!this.showMessages;localStorage.setItem(`${CHANNEL.name}_avatarDialogueToggle`,+this.showMessages);this.toggleDialogue.text(this.showMessages?"Sprite dialogue on":"Sprite dialogue off").toggleClass("btn-success btn-danger");this.updateStyle();ev.preventDefault();return false}createNameToggle(target){this.toggleNames=$("<a>").attr("href","javascript:void(0)").prop("id","avatarNameToggle").click(this.nameToggle.bind(this)).appendTo(target).addClass(this.showNametags?"btn btn-success":"btn btn-danger").text(this.showNametags?"Show nametags":"Hide nametags")}nameToggle(ev){this.showNametags=!this.showNametags;localStorage.setItem(`${CHANNEL.name}_avatarNametagToggle`,+this.showNametags);this.toggleNames.text(this.showNametags?"Show nametags":"Hide nametags").toggleClass("btn-success btn-danger");this.updateStyle();ev.preventDefault();return false}updateNavbarDropdown(data){this.roster=data;var control=$("#avatarControl");control.empty();control.addClass("dropdown");var btn=$("<a/>").addClass("dropdown-toggle").attr("href","javascript:void(0)").attr("data-toggle","dropdown").html("Choose Avatar <span class='caret'></span>").appendTo(control);var ul=$("<ul/>").addClass("dropdown-menu").addClass("columns").addClass("pull-left").css("z-index","12000").appendTo(control);for(var key in this.roster){if(this.roster[key].restricted&&CLIENT.rank<2)continue;var li=$("<li/>").appendTo(ul);(key=>{$("<a/>").text(this.roster[key].display).attr("href","javascript:void(0)").click(function(){sock.emit("pickponi",{pont:key,name:CLIENT.name})}).addClass((()=>{if(this.roster[key].restricted)return"btn btn-warning"})).appendTo(li)})(key)}this.createNavbarToggles(ul)}createNavbarToggles(ul){this.createDialogeToggle($("<li/>").appendTo(ul));this.createSpriteToggle($("<li/>").appendTo(ul));this.createNameToggle($("<li/>").appendTo(ul))}sanitizeMessage(message){var stage=document.implementation.createHTMLDocument("New").body;stage.innerHTML=message;$(".channel-emote",stage).replaceWith(function(){return $(this).attr("title")});return stage.textContent||stage.innerText||""}formatMessage(message){var wrap=$("<div/>");var span=$("<span/>").appendTo(wrap);span[0].innerHTML=message;return wrap}addMessage(data,pony){if(data.meta.addClass==="drink"||data.meta.action||data.meta.shadow){return}var message=this.sanitizeMessage(data.msg).trim();if(!message){return}$(pony).find(".avatarSprite-message").each(function(){var top=parseInt($(this).css("top").replace(/px/,""))-($(this).height()+10);$(this).css("top",top)});var msg=$("<span/>").html(this.formatMessage(message));var msgbox=$("<div/>").addClass("avatarSprite-message").css("z-index","9999").css("min-width","100px").css("background-color","rgba(80,80,80,0.75)").css("border","1px solid #aaaaaa").css("border-radius","5px").css("padding","5px").css("position","absolute").css("text-align","center").prependTo(pony);msg.appendTo(msgbox);msgbox.css("top",-parseInt(msgbox.css("height"))+5+"px");msgbox.css("left",-parseInt(msgbox.css("width"))/2+"px");msgbox.delay(6e3).hide(1,function(){$(this).remove()})}setupSocket(sock){sock.on("connect",(()=>{this.sprites.forEach((ent=>{ent.domobj.remove()}));this.sprites=[]}));sock.on("ponichoices",(data=>{this.updateNavbarDropdown(data)}));sock.on("mypone",(data=>{this.avatar=new AvatarEntity(data,this)}));sock.on("ponies",(data=>{data.forEach((cv=>{this.sprites.push(new AvatarEntity(cv,this))}))}));sock.on("newpone",(data=>{if(this.avatar&&data.id==this.avatar.id){this.sprites.push(this.avatar);return}this.sprites.push(new AvatarEntity(data,this))}));sock.on("killponi",(data=>{for(var i=0;i<this.sprites.length;i++){if(this.sprites[i].id==data){this.sprites[i].domobj.remove();this.sprites.splice(i,1);break}}}));sock.on("moveponi",(data=>{for(var i=0;i<this.sprites.length;i++){if(this.sprites[i].id===data.id&&this.sprites[i].id!=this.avatar.id){this.sprites[i].setPosition(data.x,data.y);break}}}));sock.on("stance",(data=>{for(var i=0;i<this.sprites.length;i++){if(this.sprites[i].id===data.id&&this.sprites[i].id!=this.avatar.id){this.sprites[i].switchImage(data.img);break}}}));socket.on("chatMsg",(data=>{if(!this.showSprites){return}for(var i in this.sprites){if(this.sprites[i].name.toLowerCase()==data.username.toLowerCase()){this.addMessage(data,this.sprites[i].domobj)}}}));return sock}connect(){$("#avatarSpritesToggle").show();$(".alert.alert-info").find("button").click();if(!($("#motd").css("display")==="none")){$("#motd").toggle();$("#togglemotd").find(".glyphicon-minus").removeClass("glyphicon-minus").addClass("glyphicon-plus")}$("#avatarStartup").text("Connecting...");this.sock=window.sock=this.setupSocket(io.connect(this.server));$(document).keydown((event=>{if($("input").is(":focus")||$("textarea").is(":focus"))return true;this.keys[event.keyCode]=true;switch(event.keyCode){case 37:case 38:case 39:case 40:event.preventDefault();return false;default:break}}));$(document).keyup((event=>{if($("input").is(":focus")||$("textarea").is(":focus"))return true;this.keys[event.keyCode]=false;switch(event.keyCode){case 37:case 38:case 39:case 40:event.preventDefault();return false;default:break}}));window.addEventListener("blur",(event=>{this.keys[37]=false;this.keys[38]=false;this.keys[39]=false;this.keys[40]=false}),false);setInterval(function(){var client=this;var myponi=this.avatar;if(!myponi){return}myponi.vx=client.keys[37]?-myponi.walkspeed:client.keys[39]?+myponi.walkspeed:0;myponi.vy=client.keys[38]?-myponi.walkspeed:client.keys[40]?+myponi.walkspeed:0;if(Math.abs(myponi.vx)+Math.abs(myponi.vy)>0){if(myponi.stance!="walk"){myponi.stance="walk";myponi.switchImage("walk");client.sock.emit("stance","walk")}}else{if(myponi.stance!="stand"){myponi.stance="stand";myponi.switchImage("stand");client.sock.emit("stance","stand")}return}var x=myponi.x;x+=myponi.vx;x=x<1920?x:1920;x=x>-200?x:-200;var y=myponi.y;y+=myponi.vy;y=y<1600?y:1600;y=y>-200?y:-200;myponi.setPosition(x,y);sock.emit("move",{x:x,y:y})}.bind(this),50);return this}}class AvatarEntity{constructor(data,client){Object.assign(this,{pont:data.pont||"",name:data.name||"",id:data.id,walkspeed:data.walkspeed||client.WALK_SPEED,x:data.x||0,y:data.y||0,vx:0,vy:0,width:client.roster[data.pont].width,height:client.roster[data.pont].height,stance:"stand"});this.domobj=$("<div/>").addClass("avatarSprite-sprite").attr("id","poni-"+this.id).css("position","absolute").css("top",this.x+"px").css("left",this.y+"px").css("z-index",999).css("width",this.width+"px").css("height",this.height+"px");this.imgbox=$("<div/>").appendTo(this.domobj);this.nametag=$("<div/>").addClass("avatarSprite-nametag").text(this.name).css("margin-left","-"+this.name.length+"%").css("margin-right","-"+this.name.length+"%").css("text-align","center").css("background-color","rgba(80,80,80,0.75)").css("border-radius","2px").appendTo(this.domobj);this.images={};for(var key in client.roster[this.pont].images){this.images[key]=$("<img/>").attr("src",client.roster[this.pont].images[key]).appendTo(this.imgbox).hide()}this.images.stand.show();this.domobj.prependTo("body");return this}setPosition(x2,y2){if(x2-this.x<0)this.imgbox.css("transform","scaleX(-1)");else if(!(x2==this.x)){this.imgbox.css("transform","scaleX(1)")}this.x=x2;this.y=y2;this.domobj.stop(true,true).animate({top:this.y+"px",left:this.x+"px"},50)}switchImage(img){for(var key in this.images)this.images[key].hide();this.images[img].show()}}if(CLIENT.rank>-1){CLIENT.avatarClient=(new AvatarClient).initialize()}else{socket.once("login",function(data){if(data.success){CLIENT.avatarClient=(new AvatarClient).initialize()}})}});